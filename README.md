华为 Matebook E Go 触摸优化项目
=======================

本项目旨在研究和改进华为 Matebook E Go (Himax 触摸屏) 的触摸体验。通过重构和优化用户态的触摸服务程序，我们希望解决现有驱动的一些性能瓶颈，并提升触摸数据的处理精度。
项目目标
----

当前的优化计划包括以下几个关键点：

1. **原生 Arm64 运行**：将现有的用户态程序从 `arm64ec` 架构重构为原生 `arm64`，以消除转译开销，提升执行效率。

2. **日志功能优化**：将日志记录功能修改为仅在 `Debug` 环境下启用，减少 `Release` 版本中的不必要 I/O 操作和性能损耗。

3. **触摸数据降噪**：研究并优化现有的触摸数据噪声处理算法，以提高触摸定位的准确性和响应的跟手度。

4. **驱动通信重构**：基于逆向工程分析，重构与内核驱动的通信逻辑。

Himax 驱动逆向笔记
------------

为了实现上述目标，我们对 Himax 的驱动程序进行了初步的逆向分析。以下是目前掌握的关于驱动工作流、设备和通信接口的信息。

### 工作流程 (推测)

* **初始化**：

* **手指数据获取**：

* **笔数据获取**：

### 驱动设备

| **设备 (对应简称)**             | **功能（推测）** | **注释** |
| ------------------------- | ---------- | ------ |
| `\Device\000000ee` (ee)   | 触摸帧数据传输    |        |
| `\Device\0000008e` (8e)   | IC控制命令传输   |        |
| `\Device\000000c6` (c6)   | 待发现        |        |
| `\Device\000000f0` (f0)   |            |        |
| `\Device\DeviceApi` (Api) | 笔相关        |        |

### 传输方法 (IOCTL)

| **Name**             | **IOCTL Code** | **Explain**          |
| -------------------- | -------------- | -------------------- |
| `COpenCommand`       | `0x4001c00`    |                      |
| `CCloseCommand`      | `0x4001c04`    |                      |
| `CWriteReadCommand`  | `0x4001c10`    |                      |
| `CFullDuplexCommand` | `0x4001c24`    | 使用 `8e`，拥有至少三种方法     |
| `CGetFrameCommand`   | `0x4001c28`    | 使用 `ee`，获取触摸数据       |
| `CSetTimeoutCommand` | `0x4001c2c`    |                      |
| `CSetBlockCommamnd`  | `0x4001c30`    |                      |
| `CSetResetCommand`   | `0x4001c34`    |                      |
| `CReadAcpiCommand`   | `0x4001c38`    |                      |
| `CCommand`           | 待发现            |                      |
| `CReadCommand`       | 待发现            |                      |
| `CWriteCommand`      | 待发现            |                      |
| `待定`                 | `0x470807`     | HIMX控制相关             |
| `待定`                 | `0x470813`     | 与笔相关, 使用 `DeviceApi` |

### 控制方法详解

#### CFullDuplexCommand

* **设备**: `\Device\0000008e`

* **调用 1**:
  
  * IOCTL：`0x4001C24`
  
  * 输入缓冲区 (5字节): `f3 31 00 00 00`
  
  * 输出缓冲区 (5字节)

* **调用 2**:
  
  * 输入缓冲区: `f3 a8 00 00 00 00 00`

* **调用 3**:
  
  * 输入缓冲区: `f3 e4 00 00 00 00 00`

#### CGetFrameCommand

* **设备**: `\Device\000000ee`

* (用于获取触摸数据帧)

贡献
--

欢迎对此项目感兴趣的开发者提交 Pull Requests 或 Issues。
免责声明
----

本项目基于逆向工程研究，仅用于技术学习和交流目的。所有代码和分析仅代表本项目的观点，与华为或 Himax 官方无关。使用者应自行承担使用本项目代码可能带来的任何风险。
